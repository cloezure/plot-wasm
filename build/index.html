<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WasmTest</title>
  </head>
  <body>
    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    <input type="button" value="Draw" onclick="callAdd()" />
    <script type='text/javascript'>

      let SSE = new EventSource('http://' + '10.16.0.156' + ':' + 3030 + '/get-all-spectrums');

      function base64ToArrayBuffer(base64) {
          let bs = window.atob(base64)
          let len = bs.length
          let bytes = new Uint8Array(len)
          for(let i = 0; i < len; i++) {
              bytes[i] = bs.charCodeAt(i);
          }
          return bytes.buffer;
      }

      var Module = {
          canvas: (function() {
              return document.getElementById('canvas');
          })(),
      };

      // function callAdd() {
          SSE.onmessage = msg => {
              
              let buffer = base64ToArrayBuffer(msg.data)
              let view = new DataView(buffer)
              
              let sp = view.getUint32(0, true)
              let rc = view.getUint32(4, true)
              let scs = 8 + 4 * rc

              for (let sidx = 0; sidx < scs; sidx++) {
                  let offset = 8 + sidx * scs;
                  Module.ccall('draw_trace',
                               null,
                               ['number', 'number', 'number', 'number'],
                               [view.getFloat32(offset, true),
                                view.getFloat32(offset + 4, true),
                                new Float32Array(buffer.slice(offset + 8, offset + scs)),
                                rc]);
              }
              console.log("ON")
          }
      // }
      // const test = Module.cwrap("test", "number", ["number", "number"]);

      // console.log(test(10, 10));
      // const draw_api = Module.cwrap



      

      // var draw_trace = Module.cwrap("draw_trace", "",
      //                               ["number", "number", "number", "number"]);
      // var test = Module.cwrap("test", "number", ["number", "number"]);

      // console.log()

      // SSE.onmessage = msg => {
      //     let buffer = base64ToArrayBuffer(msg.data)
      //     let view = new DataView(buffer)
          
      //     let sp = view.getUint32(0, true)
      //     let rc = view.getUint32(4, true)
      //     let scs = 8 + 4 * rc

      //     for (let sidx = 0; sidx < scs; sidx++) {
      //         let offset = 8 + sidx * scs;
      //         draw_trace(view.getFloat32(offset, true),
      //                        view.getFloat32(offset + 4, true),
      //                        new Float32Array(view.slice(offset + 8, offset + scs)),
      //                        rc)
      //     }
      // }
      // };
      
      // draw_spec = Module.cwrap('draw_spec', ['Float32Array', 'number', 'number', 'number'], [null, 0, 0, 0]);
      
    </script>
    <script async type="text/javascript" src="plot.js"></script>
  </body>
</html>
